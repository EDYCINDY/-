<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>All-in-One Dev Editor V14.1 (Save As Modal FIX) | Edy Sahputra</title>
    
    <!-- Bagian HEAD (CSS & Library) TIDAK DIUBAH, kecuali penyesuaian Style Modal -->
    <link rel="manifest" href="./manifest.json">
    <meta name="theme-color" content="#343a40">
    <link href='./favicon.ico' rel='icon' type='image/x-icon' />

    <!-- Library CSS (Dipertahankan) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/theme/material-darker.min.css"> 
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/theme/dracula.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/theme/eclipse.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/theme/idea.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/theme/monokai.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/theme/default.min.css"> 
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/lint/lint.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/fold/foldgutter.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/dialog/dialog.min.css">

    <!-- Library JS (di Head) -->
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/htmlhint/1.1.4/htmlhint.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/csslint/1.0.5/csslint.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jshint/2.13.6/jshint.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/js-beautify/1.14.0/beautify.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/js-beautify/1.14.0/beautify-html.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/js-beautify/1.14.0/beautify-css.min.js"></script>

    <style>
        /* CSS Utama (Dipertahankan) */
        :root {
            --primary-color: #0d6efd;
            --dark-bg: #212529;
            --light-text: #f8f9fa;
            --main-bg-color: #343a40; 
        }
        
        * { box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            background-color: var(--main-bg-color); 
            color: var(--light-text);
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 0;
            min-height: 100vh;
            transition: background-color 0.3s ease;
        }
        .container {
            width: 100%;
            height: 100vh;
            display: flex;
            flex-direction: column;
            padding: 0;
            margin: 0;
            overflow: hidden;
        }
        .header {
            text-align: center;
            padding: 10px;
            background-color: var(--dark-bg);
            border-bottom: 3px solid var(--primary-color);
        }
        .header h2 { margin: 0; color: var(--primary-color); font-weight: 700; font-size: 1.5rem; }
        .header .credit { margin-top: 5px; font-size: 0.85rem; color: #adb5bd; }
        
        /* CodeMirror Customization, FAB, PWA Prompts (Dipertahankan) */
        .CodeMirror { flex-grow: 1; height: auto; font-family: 'Fira Code', 'Consolas', monospace; font-size: 16px; border: none; border-radius: 0; min-height: 0; }
        .CodeMirror.full-render { height: fit-content !important; overflow: visible !important; }
        #status { padding: 8px 15px; font-size: 0.9rem; text-align: left; opacity: 0; transition: opacity 0.3s ease; background-color: #343a40; color: white; border-top: 1px solid #495057; flex-shrink: 0; }
        #status.show { opacity: 1; }
        #status.success { background-color: #198754; }
        #status.error { background-color: #dc3545; }
        #status.loading { background-color: #0dcaf0; color: var(--dark-bg); }
        .fab-container { position: fixed; bottom: 25px; right: 25px; z-index: 1000; }
        .fab-main { background-color: var(--primary-color); color: white; width: 60px; height: 60px; border-radius: 50%; border: none; box-shadow: 0 4px 10px rgba(0, 0, 0, 0.4); font-size: 24px; cursor: pointer; transition: transform 0.3s ease; outline: none; }
        .fab-main.open { transform: rotate(45deg); }
        .fab-menu { position: absolute; bottom: 70px; right: 0; display: flex; flex-direction: column-reverse; gap: 10px; opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0.3s; }
        .fab-container.open .fab-menu { opacity: 1; visibility: visible; }
        .fab-button { background-color: #343a40; color: white; width: 50px; height: 50px; border-radius: 50%; border: none; box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3); font-size: 18px; cursor: pointer; position: relative; transition: background-color 0.2s; outline: none; }
        .fab-dropdown { position: relative; }
        .fab-sub-menu { position: absolute; right: 60px; bottom: 0; background: #343a40; border-radius: 8px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3); padding: 8px; display: none; flex-direction: column; gap: 5px; min-width: 200px; z-index: 100; }
        .fab-sub-menu.show { display: flex; }
        .fab-sub-menu button { background: transparent; color: white; border: none; padding: 8px 10px; text-align: left; border-radius: 4px; cursor: pointer; display: flex; align-items: center; gap: 8px; font-size: 0.9rem; outline: none; }
        .fab-sub-menu button:hover { background-color: #495057; }
        .fab-dropdown h4 { color: var(--primary-color); margin: 5px 10px; font-size: 0.85rem; text-transform: uppercase; font-weight: 700; }
        .full-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.8); z-index: 10000; display: none; justify-content: center; align-items: center; padding: 20px; }
        .full-overlay.show { display: flex; }
        .overlay-content { background-color: var(--dark-bg); padding: 25px; border-radius: 12px; max-height: 90%; overflow-y: auto; width: 95%; max-width: 600px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.6); transform: scale(0.95); opacity: 0; transition: transform 0.3s ease, opacity 0.3s ease; }
        .full-overlay.show .overlay-content { transform: scale(1); opacity: 1; }
        .overlay-content h3 { color: var(--primary-color); margin-top: 0; border-bottom: 2px solid #495057; padding-bottom: 10px; }
        .mode-button-grid, .theme-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(130px, 1fr)); gap: 12px; margin-bottom: 20px; }
        .mode-button-grid button, .theme-grid button { background-color: #343a40; color: white; border: 1px solid #495057; padding: 10px; border-radius: 8px; cursor: pointer; transition: background-color 0.2s; display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 0.9rem; height: 80px; outline: none; }
        .mode-button-grid button:hover, .theme-grid button:hover, .mode-button-grid button.active, .theme-grid button.active { background-color: var(--primary-color); border: 2px solid var(--primary-color); box-shadow: 0 0 5px var(--primary-color); }
        .close-btn-container { text-align: right; border-top: 1px solid #495057; padding-top: 15px; }
        .close-btn { background-color: #dc3545; color: white; border: none; padding: 10px 15px; border-radius: 6px; cursor: pointer; outline: none; }
        .color-picker-container { display: flex; align-items: center; gap: 15px; margin-bottom: 20px; background: #343a40; padding: 10px; border-radius: 8px; border: 1px solid #495057; }
        .color-picker-container label { font-weight: 600; }
        .color-picker-container input[type="color"] { -webkit-appearance: none; -moz-appearance: none; appearance: none; border: none; width: 50px; height: 50px; background: none; cursor: pointer; }
        .color-picker-container input[type="color"]::-webkit-color-swatch-wrapper { padding: 0; }
        .color-picker-container input[type="color"]::-webkit-color-swatch { border: 2px solid white; border-radius: 50%; }
        .install-prompt, .update-notification { position: fixed; z-index: 2000; padding: 15px 25px; border-radius: 12px; box-shadow: 0 6px 15px rgba(0, 0, 0, 0.4); display: none; align-items: center; justify-content: space-between; width: 90%; max-width: 500px; }
        .install-prompt { bottom: 20px; left: 50%; transform: translateX(-50%); background-color: #007bff; color: white; }
        .install-prompt p { margin: 0; padding-right: 20px; font-weight: 500; }
        .tombol-install { background-color: #ffffff; color: #007bff; border: none; padding: 10px 18px; border-radius: 8px; cursor: pointer; font-weight: bold; white-space: nowrap; }
        .tombol-install:hover { background-color: #f0f0f0; }
        .install-prompt.hidden { display: none; }
        .update-notification { top: 10px; right: 10px; background: #ffc107; color: #212529; gap: 15px; }
        .update-notification p { margin: 0; }
        .update-notification button { background: #212529; color: white; padding: 5px 10px; border-radius: 5px; border: none; cursor: pointer; }
        
        /* BARU: Gaya untuk Save As Modal */
        #dlOverlay .overlay-content {
            max-width: 400px;
        }
        .save-button-grid {
             display: grid;
             grid-template-columns: repeat(2, 1fr);
             gap: 8px;
        }
        .save-button-grid button {
            background-color: #495057;
            color: white;
            border: 1px solid #6c757d;
            padding: 10px;
            border-radius: 6px;
            text-align: center;
            font-size: 0.9rem;
            transition: background-color 0.2s;
        }
        .save-button-grid button:hover {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }
    </style>
    <script>
        // Registrasi Service Worker (Dipertahankan)
        if ('serviceWorker' in navigator) {
          navigator.serviceWorker.register('service-worker.js')
            .then(function (registration) {
              console.log('ServiceWorker registered with scope:', registration.scope);
            })
            .catch(function (error) {
              console.log('ServiceWorker registration failed:', error);
            });
        }
    </script> 
</head>
<body>

     <!-- PWA Update Notification & Install Prompt (Dipertahankan) -->
     <div id="updateNotification" class="update-notification">
        <p style="margin: 0;">Versi baru tersedia! Muat ulang untuk update.</p>
        <button id="reloadButton">Perbarui</button>
     </div>
     <div id="install-container" class="install-prompt hidden">
        <p>Install Aplikasi untuk pengalaman terbaik di perangkat Anda!</p>
        <button id="install-button" class="tombol-install">Install Sekarang</button>
      </div>

    <div class="container">
        <div class="header">
            <h2><i class="fas fa-hammer"></i> All-in-One Dev Editor</h2>
            <div class="credit">Dibuat oleh <strong>Edy Sahputra</strong> - Mendukung Android & Windows App</div>
        </div>
        <textarea id="editor-area" name="editor-area">
/* * Selamat Datang di All-in-One Dev Editor
 * */
 
<!DOCTYPE html>
<html lang="id">
<head>
    <title>Kode Edy V14.1</title>
</head>
<body>
    <h1>Editor Siap Pakai!</h1>
    <p>Ini adalah baris duplikasi.</p>
    <p>Ini adalah baris duplikasi.</p>
</body>
</html>
        </textarea>
        <div id="status">Status: Editor dimuat.</div>
    </div>
    
    <div id="fabContainer" class="fab-container">
        <div class="fab-menu">
            <button class="fab-button" onclick="toggleSettingsOverlay()" title="Pengaturan Tampilan & Tema">
                <i class="fas fa-cog"></i>
            </button>
            
            <div class="fab-dropdown" onmouseleave="hideSubMenu('utilityDropdown')">
                <button class="fab-button" onclick="toggleSubMenu('utilityDropdown')" title="Utility & Manipulasi Teks">
                    <i class="fas fa-tools"></i>
                </button>
                <div id="utilityDropdown" class="fab-sub-menu">
                    <h4>Manipulasi Kode</h4>
                    <button onclick="formatCode()"><i class="fas fa-indent"></i> **Format Kode (Beautify)**</button>
                    <button onclick="showSearchDialog()"><i class="fas fa-search"></i> **Cari & Ganti**</button>
                    <button onclick="removeDuplicateLines()"><i class="fas fa-trash-alt"></i> **Hapus Duplikasi Baris**</button>
                    <hr style="margin: 5px 0; border-color: #495057;">
                    <h4>Teks</h4>
                    <button onclick="manipulateText('upper')"><i class="fas fa-arrow-up"></i> Uppercase</button>
                    <button onclick="manipulateText('lower')"><i class="fas fa-arrow-down"></i> Lowercase</button>
                    <button onclick="manipulateText('base64encode')"><i class="fas fa-lock"></i> Base64 Encode</button>
                    <button onclick="manipulateText('base64decode')"><i class="fas fa-unlock"></i> Base64 Decode</button>
                </div>
            </div>
            <div class="fab-dropdown" onmouseleave="hideSubMenu('actionDropdown')">
                <button class="fab-button" onclick="toggleSubMenu('actionDropdown')" title="Aksi Editor">
                    <i class="fas fa-ellipsis-v"></i>
                </button>
                <div id="actionDropdown" class="fab-sub-menu">
                    <h4>Navigasi & Aksi</h4>
                    <button onclick="zoomIn()"><i class="fas fa-search-plus"></i> Perbesar Tulisan</button>
                    <button onclick="zoomOut()"><i class="fas fa-search-minus"></i> Perkecil Tulisan</button>
                    <hr style="margin: 5px 0; border-color: #495057;">
                    <button onclick="undo()"><i class="fas fa-undo"></i> Undo</button>
                    <button onclick="redo()"><i class="fas fa-redo"></i> Redo</button>
                    <button onclick="shareAsText()"><i class="fas fa-share-alt"></i> Bagikan Text</button>
                    <hr style="margin: 5px 0; border-color: #495057;">
                    <button onclick="clearNotes()" style="color: #dc3545;"><i class="fas fa-trash"></i> **Reset Editor**</button>
                </div>
            </div>
            <!-- Perubahan: Hapus dlSubDropdown dari sini -->
            <div class="fab-dropdown" onmouseleave="hideSubMenu('fileDropdown')">
                <button class="fab-button" onclick="toggleSubMenu('fileDropdown')" title="File & Export">
                    <i class="fas fa-file-alt"></i>
                </button>
                <div id="fileDropdown" class="fab-sub-menu">
                    <h4>File</h4>
                    <button onclick="document.getElementById('fileInput').click(); hideSubMenu('fileDropdown')"><i class="fas fa-folder-open"></i> **Buka File Lokal**</button>
                    <hr style="margin: 5px 0; border-color: #495057;">
                    <h4>Ekspor</h4>
                    <button onclick="toggleModeOverlay(); hideSubMenu('fileDropdown')"><i class="fas fa-laptop-code"></i> **Ubah Mode Bahasa**</button>
                    <button onclick="convertAndDownloadJpg(); hideSubMenu('fileDropdown')"><i class="fas fa-image"></i> Unduh Full JPG (FAST FIX)</button>
                    <hr style="margin: 5px 0; border-color: #495057;">
                    <!-- PERUBAHAN: Tombol ini sekarang memanggil modal baru -->
                    <button onclick="toggleDlOverlay()"><i class="fas fa-download"></i> Simpan File As...</button> 
                </div>
            </div>
        </div>
        
        <button id="fabMainBtn" class="fab-main" onclick="toggleFabMenu()" title="Buka Menu">
            <i class="fas fa-plus"></i>
        </button>
    </div>
    
    <!-- BARU: Save As Modal (Overlay Mengambang) -->
    <div id="dlOverlay" class="full-overlay">
        <div class="overlay-content">
             <h3><i class="fas fa-save"></i> Pilih Format Simpan</h3>
             <p>Pilih ekstensi file yang diinginkan:</p>
             <div class="save-button-grid">
                <button onclick="downloadFile('html')"><i class="fab fa-html5"></i> HTML (.html)</button>
                <button onclick="downloadFile('css')"><i class="fab fa-css3-alt"></i> CSS (.css)</button>
                <button onclick="downloadFile('js')"><i class="fab fa-js"></i> JavaScript (.js)</button>
                <button onclick="downloadFile('json')"><i class="fas fa-database"></i> JSON (.json)</button>
                <button onclick="downloadFile('xml')"><i class="fas fa-code"></i> XML (.xml)</button>
                <button onclick="downloadFile('java')"><i class="fab fa-java"></i> Java (.java)</button>
                <button onclick="downloadFile('cs')"><i class="fas fa-terminal"></i> C# (.cs)</button>
                <button onclick="downloadFile('py')"><i class="fab fa-python"></i> Python (.py)</button>
                <button onclick="downloadFile('md')"><i class="fab fa-markdown"></i> Markdown (.md)</button>
                <button onclick="downloadFile('txt')"><i class="fas fa-file-alt"></i> Teks Polos (.txt)</button>
             </div>
             <hr style="margin: 15px 0; border-color: #495057;">
             <button style="width: 100%; background-color: #6c757d; color:white;" onclick="downloadCustom()"><i class="fas fa-terminal"></i> **Ekstensi Lain (Custom)**</button>
             <div class="close-btn-container">
                 <button class="close-btn" onclick="toggleDlOverlay()">Batal/Tutup</button>
             </div>
        </div>
    </div>


    <!-- Modals (Mode & Settings) - Dipertahankan -->
    <div id="mode-overlay" class="full-overlay">
        <div class="overlay-content">
            <h3><i class="fas fa-laptop-code"></i> Pilih Mode Bahasa</h3>
            <div class="mode-button-grid">
                <button id="mode-htmlmixed" onclick="setMode('htmlmixed')"><i class="fab fa-html5"></i> HTML/CSS/JS</button>
                <button id="mode-javascript" onclick="setMode('javascript')"><i class="fab fa-js"></i> JavaScript</button>
                <button id="mode-css" onclick="setMode('css')"><i class="fab fa-css3-alt"></i> CSS/SCSS</button>
                <button id="mode-xml" onclick="setMode('xml')"><i class="fas fa-code"></i> XML/SVG</button>
                <button id="mode-json" onclick="setMode('application/json')"><i class="fas fa-database"></i> JSON</button>
                <button id="mode-clike" onclick="setMode('text/x-java')"><i class="fab fa-java"></i> Java</button>
                <button id="mode-csharp" onclick="setMode('text/x-csharp')"><i class="fas fa-terminal"></i> C#</button>
                <button id="mode-python" onclick="setMode('python')"><i class="fab fa-python"></i> Python</button>
                <button id="mode-markdown" onclick="setMode('markdown')"><i class="fab fa-markdown"></i> Markdown</button>
                <button id="mode-plaintext" onclick="setMode('text/plain')"><i class="fas fa-file-alt"></i> Teks Polos</button>
            </div>
            <div class="close-btn-container">
                <button class="close-btn" onclick="toggleModeOverlay()">Tutup</button>
            </div>
        </div>
    </div>
    
    <div id="settings-overlay" class="full-overlay">
        <div class="overlay-content">
            <h3><i class="fas fa-palette"></i> Pengaturan Tampilan</h3>
            
            <div class="color-picker-container">
                <label for="bodyColorPicker">Warna Background Aplikasi:</label>
                <input type="color" id="bodyColorPicker" value="#343a40" onchange="changeBodyBackground(this.value)">
                <span>(Ubah warna di luar editor)</span>
            </div>
            
            <h4><i class="fas fa-paint-brush"></i> Tema Code Editor</h4>
            <div class="theme-grid">
                <button id="theme-material-darker" onclick="setTheme('material-darker')"><i class="fas fa-moon"></i> Material Darker</button>
                <button id="theme-dracula" onclick="setTheme('dracula')"><i class="fas fa-theater-mask"></i> Dracula</button>
                <button id="theme-idea" onclick="setTheme('idea')"><i class="fas fa-sun"></i> Idea (Light)</button>
                <button id="theme-eclipse" onclick="setTheme('eclipse')"><i class="fas fa-glasses"></i> Eclipse (Light)</button>
                <button id="theme-monokai" onclick="setTheme('monokai')"><i class="fas fa-ghost"></i> Monokai</button>
                <button id="theme-default" onclick="setTheme('default')"><i class="fas fa-redo-alt"></i> Default</button>
            </div>
            <div class="close-btn-container">
                <button class="close-btn" onclick="toggleSettingsOverlay()">Tutup Pengaturan</button>
            </div>
        </div>
    </div>
    <input type="file" id="fileInput" hidden onchange="handleFileSelect(event)">
    
    <!-- CodeMirror JS Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/xml/xml.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/javascript/javascript.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/css/css.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/htmlmixed/htmlmixed.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/clike/clike.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/python/python.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/markdown/markdown.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/meta.min.js"></script>
    
    <!-- CodeMirror Addons -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/lint/lint.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/lint/html-lint.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/lint/css-lint.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/lint/json-lint.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/lint/javascript-lint.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/edit/matchbrackets.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/selection/active-line.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/edit/closebrackets.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/fold/foldcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/fold/foldgutter.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/fold/xml-fold.min.js"></script>

    <!-- CodeMirror Search & Dialog Addons -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/search/searchcursor.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/search/search.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/dialog/dialog.min.js"></script>

    <script>
        const STORAGE_KEY = 'notepad_v14_edy_data_v5'; 
        const SETTINGS_KEY = 'notepad_v14_edy_settings_v5'; 
        let cm;
        let currentMode = 'htmlmixed'; 
        const statusEl = document.getElementById('status');
        const fabContainer = document.getElementById('fabContainer');
        const modeOverlay = document.getElementById('mode-overlay');
        const settingsOverlay = document.getElementById('settings-overlay');
        // BARU: Elemen untuk Save As Modal
        const dlOverlay = document.getElementById('dlOverlay');
        const bodyEl = document.body;
        
        // Configuration (Dipertahankan)
        const FILE_CONFIGS = {
            'html': { ext: '.html', mime: 'text/html', mode: 'htmlmixed' },
            'css': { ext: '.css', mime: 'text/css', mode: 'css' },
            'js': { ext: '.js', mime: 'application/javascript', mode: 'javascript' },
            'json': { ext: '.json', mime: 'application/json', mode: 'application/json' },
            'xml': { ext: '.xml', mime: 'application/xml', mode: 'xml' },
            'java': { ext: '.java', mime: 'text/x-java', mode: 'text/x-java' },
            'cs': { ext: '.cs', mime: 'text/x-csharp', mode: 'text/x-csharp' },
            'py': { ext: '.py', mime: 'text/x-python', mode: 'python' },
            'md': { ext: '.md', mime: 'text/markdown', mode: 'markdown' },
            'txt': { ext: '.txt', mime: 'text/plain', mode: 'text/plain' }
        };
        const MODE_MAP = {
            'htmlmixed': { name: 'HTML/Mixed', lint: true, elId: 'mode-htmlmixed' },
            'javascript': { name: 'JavaScript', lint: true, elId: 'mode-javascript' },
            'css': { name: 'CSS/SCSS', lint: true, elId: 'mode-css' },
            'xml': { name: 'XML/SVG', lint: true, elId: 'mode-xml' },
            'application/json': { name: 'JSON', lint: true, elId: 'mode-json' },
            'text/x-java': { name: 'Java/C/C++', lint: false, elId: 'mode-clike' },
            'text/x-csharp': { name: 'C#', lint: false, elId: 'mode-csharp' },
            'python': { name: 'Python', lint: false, elId: 'mode-python' },
            'markdown': { name: 'Markdown', lint: false, elId: 'mode-markdown' },
            'text/plain': { name: 'Teks Polos', lint: false, elId: 'mode-plaintext' },
        };
        function getModeConfig(cmMode) {
             const found = Object.keys(MODE_MAP).includes(cmMode) ? MODE_MAP[cmMode] : Object.values(MODE_MAP).find(c => c.name === cmMode);
             return found || MODE_MAP['text/plain'];
        }
        const DEFAULT_SETTINGS = {
            theme: 'material-darker',
            mode: 'htmlmixed',
            bodyBgColor: '#343a40',
            fontSize: 16
        };
        let appSettings = JSON.parse(localStorage.getItem(SETTINGS_KEY)) || DEFAULT_SETTINGS;

        // --- Initialization ---
        window.onload = () => {
            window.html_beautify = window.html_beautify || function(code) { return code; };
            window.js_beautify = window.js_beautify || function(code) { return code; };
            window.css_beautify = window.css_beautify || function(code) { return code; };
            
            applyInitialSettings();
            initEditor();
            checkCapabilities();
        };

        // ... (Fungsi applyInitialSettings, updateActiveButtons, saveSettings, initEditor, Theme & Zoom functions DIIZINKAN TIDAK DITAMPILKAN KARENA SAMA DENGAN V14.0) ...
        function applyInitialSettings() {
            setTheme(appSettings.theme, false);
            changeBodyBackground(appSettings.bodyBgColor, false);
            document.getElementById('bodyColorPicker').value = appSettings.bodyBgColor;
            setFontSize(appSettings.fontSize, false);
            updateActiveButtons(appSettings.mode, appSettings.theme); 
        }
        function updateActiveButtons(mode, theme) {
            document.querySelectorAll('.mode-button-grid button').forEach(btn => btn.classList.remove('active'));
            const modeConfig = getModeConfig(mode);
            if (modeConfig && modeConfig.elId) {
                const activeModeBtn = document.getElementById(modeConfig.elId);
                if(activeModeBtn) activeModeBtn.classList.add('active');
            }
            document.querySelectorAll('.theme-grid button').forEach(btn => btn.classList.remove('active'));
            const activeThemeBtn = document.getElementById(`theme-${theme}`);
            if(activeThemeBtn) activeThemeBtn.classList.add('active');
        }
        function saveSettings(key, value) {
            appSettings[key] = value;
            localStorage.setItem(SETTINGS_KEY, JSON.stringify(appSettings));
        }
        function initEditor() {
            const initialMode = appSettings.mode || 'htmlmixed';
            const modeConfig = getModeConfig(initialMode);
            cm = CodeMirror.fromTextArea(document.getElementById('editor-area'), {
                lineNumbers: true,
                mode: initialMode,
                theme: appSettings.theme,
                indentUnit: 4,
                lineWrapping: true,
                gutters: ["CodeMirror-linenumbers", "CodeMirror-foldgutter", "CodeMirror-lint-markers"], 
                lint: modeConfig.lint, 
                viewportMargin: 50, // Performa FIX
                matchBrackets: true,
                autoCloseBrackets: true,
                styleActiveLine: true,
                foldGutter: true
            });
            currentMode = initialMode;
            
            cm.getWrapperElement().style.fontSize = `${appSettings.fontSize}px`;
            const saved = localStorage.getItem(STORAGE_KEY);
            if (saved) {
                cm.setValue(saved);
                cm.clearHistory();
            }
            
            cm.on('change', () => {
                localStorage.setItem(STORAGE_KEY, cm.getValue());
                if (cm.getOption('lint')) {
                     CodeMirror.signal(cm, 'change', cm); 
                }
            });
            showStatus(`Editor dimuat. Mode: ${modeConfig.name} | Tema: ${appSettings.theme}`, 'loading', 3000);
        }
        function changeBodyBackground(color, save = true) {
            bodyEl.style.backgroundColor = color;
            document.documentElement.style.setProperty('--main-bg-color', color);
            if (save) {
                saveSettings('bodyBgColor', color);
                showStatus(`Warna Background diubah ke ${color}`, 'success', 2000);
            }
        }
        function setTheme(themeName, save = true) {
            if (cm) { cm.setOption('theme', themeName); }
            updateActiveButtons(currentMode, themeName);
            if (save) {
                saveSettings('theme', themeName);
                showStatus(`Tema Editor diubah ke: ${themeName}`, 'success', 2000);
            }
        }
        function setFontSize(size, save = true) {
            if (cm) {
                cm.getWrapperElement().style.fontSize = `${size}px`;
                cm.refresh(); 
            }
            if (save) {
                saveSettings('fontSize', size);
                showStatus(`Ukuran tulisan diubah menjadi: ${size}px`, 'success', 1500);
            }
        }
        function zoomIn() {
            const newSize = Math.min(appSettings.fontSize + 2, 30);
            setFontSize(newSize);
        }
        function zoomOut() {
            const newSize = Math.max(appSettings.fontSize - 2, 10);
            setFontSize(newSize);
        }
        function checkCapabilities() {
            if (!navigator.share) {
                const btn = document.querySelector('#actionDropdown button[onclick="shareAsText()"]');
                if (btn) {
                    btn.disabled = true;
                    btn.innerHTML = '<i class="fas fa-ban"></i> Bagikan (Unsupported)';
                    btn.style.opacity = '0.6';
                }
            }
        }

        // --- FAB & Overlay Helpers ---
        function toggleFabMenu() {
            fabContainer.classList.toggle('open');
            document.getElementById('fabMainBtn').classList.toggle('open');
            if (!fabContainer.classList.contains('open')) {
                hideAllSubMenus();
            }
        }
        function toggleSubMenu(id) {
            const subMenu = document.getElementById(id);
            document.querySelectorAll('.fab-sub-menu').forEach(menu => {
                 if (menu !== subMenu) menu.classList.remove('show');
            });
            subMenu.classList.toggle('show');
        }
        function hideSubMenu(id) {
             const subMenu = document.getElementById(id);
             if (subMenu) subMenu.classList.remove('show');
        }
        function hideAllSubMenus() {
            document.querySelectorAll('.fab-sub-menu').forEach(menu => menu.classList.remove('show'));
        }
        function toggleOverlay(overlayEl) {
            const isShowing = overlayEl.classList.toggle('show');
            if (isShowing) {
                hideAllSubMenus();
            }
        }
        function toggleModeOverlay() { toggleOverlay(modeOverlay); }
        function toggleSettingsOverlay() { toggleOverlay(settingsOverlay); }
        
        // FUNGSI BARU: Toggle Save As Modal
        function toggleDlOverlay() {
            toggleOverlay(dlOverlay);
            // Tutup semua sub-menu FAB saat modal Save As terbuka
            hideAllSubMenus(); 
        }

        function setMode(mode) {
            const modeConfig = getModeConfig(mode);
            cm.setOption('mode', mode); 
            cm.setOption('lint', modeConfig.lint);
            currentMode = mode;
            saveSettings('mode', mode); 
            updateActiveButtons(mode, appSettings.theme);
            showStatus(`Mode diubah ke: ${modeConfig.name}. Linting ${modeConfig.lint ? 'aktif' : 'nonaktif'}.`, 'success');
            toggleModeOverlay();
            cm.focus();
        }

        // --- Utility Functions (Beautify, Search, Deduplicate) ---
        function formatCode() { /* ... (Kode formatCode tidak diubah) ... */
            const mode = cm.getOption('mode');
            let code = cm.getValue();
            let formatted = '';
            try {
                if (mode === 'htmlmixed' || mode === 'xml') { formatted = html_beautify(code, { indent_size: 4 }); } 
                else if (mode === 'javascript' || mode === 'application/json') { formatted = js_beautify(code, { indent_size: 4 }); } 
                else if (mode === 'css') { formatted = css_beautify(code, { indent_size: 4 }); } 
                else { return showStatus('Format kode hanya didukung untuk HTML, CSS, JavaScript, dan JSON.', 'info'); }
                cm.setValue(formatted);
                showStatus('Kode berhasil diformat (Beautify)!', 'success');
            } catch (e) {
                console.error('Beautify Error:', e);
                showStatus('Gagal memformat kode. Periksa sintaks.', 'error');
            }
        }
        function showSearchDialog() { /* ... (Kode showSearchDialog tidak diubah) ... */
            if (cm) { CodeMirror.commands.find(cm); }
            showStatus('Dialog Cari & Ganti ditampilkan.', 'info', 3000);
            hideAllSubMenus();
        }
        function removeDuplicateLines() { /* ... (Kode removeDuplicateLines tidak diubah) ... */
            const code = cm.getValue();
            const lines = code.split('\n');
            const uniqueLines = [...new Set(lines)]; 
            const newCode = uniqueLines.join('\n');

            if (code !== newCode) {
                const removedCount = lines.length - uniqueLines.length;
                cm.setValue(newCode);
                showStatus(`Berhasil menghapus ${removedCount} baris duplikasi!`, 'success');
            } else {
                showStatus('Tidak ditemukan duplikasi baris dalam kode.', 'info');
            }
            hideAllSubMenus();
        }
        function manipulateText(type) { /* ... (Kode manipulateText tidak diubah) ... */
            const selection = cm.getSelection();
            if (!selection) return showStatus('Pilih teks terlebih dahulu.', 'info');
            let result = selection;
            try {
                switch(type) {
                    case 'upper': result = selection.toUpperCase(); break;
                    case 'lower': result = selection.toLowerCase(); break;
                    case 'base64encode':
                        result = btoa(encodeURIComponent(selection).replace(/%([0-9A-F]{2})/g, (match, p1) => String.fromCharCode('0x' + p1)));
                        break;
                    case 'base64decode':
                        result = decodeURIComponent(atob(selection).split('').map((c) => {
                            return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
                        }).join(''));
                        break;
                    default: return;
                }
                cm.replaceSelection(result);
                showStatus(`${type} berhasil dilakukan!`, 'success');
            } catch (e) {
                console.error('Manipulation Error:', e);
                showStatus(`Gagal melakukan ${type}: Teks tidak valid/format Base64 salah.`, 'error');
            }
            hideAllSubMenus();
        }

        // --- Operasi File, JPG, Share, Status ---
        function showStatus(message, type = 'info', duration = 3000) { /* ... (Kode showStatus tidak diubah) ... */
            clearTimeout(statusEl.timeoutId);
            statusEl.className = 'show ' + (type || 'info');
            statusEl.textContent = 'Status: ' + message;
            
            if (duration > 0) {
                statusEl.timeoutId = setTimeout(() => {
                    statusEl.classList.remove('show');
                }, duration);
            }
        }
        function undo() { cm.undo(); showStatus('Undo dilakukan.', 'loading', 1000); }
        function redo() { cm.redo(); showStatus('Redo dilakukan.', 'loading', 1000); }
        function clearNotes() {
            if (confirm('Hapus semua kode dan mulai baru? Tindakan ini tidak dapat dibatalkan.')) {
                cm.setValue('// Editor di-reset.');
                cm.clearHistory();
                localStorage.removeItem(STORAGE_KEY);
                showStatus('Editor di-reset', 'error');
            }
        }
        function handleFileSelect(e) { /* ... (Kode handleFileSelect tidak diubah) ... */
            const file = e.target.files[0];
            if (!file) return;
            if (file.size > 5 * 1024 * 1024) return showStatus('File terlalu besar (Maks 5MB)', 'error');
            const reader = new FileReader();
            reader.onload = (ev) => {
                cm.setValue(ev.target.result);
                cm.clearHistory();
                const ext = file.name.split('.').pop().toLowerCase();
                const config = Object.values(FILE_CONFIGS).find(c => c.ext.includes(ext));
                let modeToSet = 'text/plain';
                if (config) {
                    modeToSet = config.mode;
                } else if (ext === 'py') {
                    modeToSet = 'python';
                } else if (ext === 'md') {
                    modeToSet = 'markdown';
                } else if (['kt', 'c', 'cpp', 'h'].includes(ext)) {
                    modeToSet = 'text/x-java'; 
                }
                setMode(modeToSet); 
                showStatus(`File dimuat: ${file.name}. Mode: ${getModeConfig(modeToSet).name}.`);
            };
            reader.readAsText(file);
            e.target.value = '';
        }

        // PERUBAHAN: Fungsi downloadFile sekarang juga menutup Modal Save As
        function downloadFile(type) {
            const cfg = FILE_CONFIGS[type] || { ext: '.' + type, mime: 'text/plain' };
            toggleDlOverlay(); // Tutup modal
            startDownload(cfg.ext, cfg.mime);
        }
        function downloadCustom() {
            const ext = prompt('Masukkan ekstensi (contoh: .json, .xml, .kt):', '.txt');
            if (ext) {
                 toggleDlOverlay(); // Tutup modal
                 startDownload(ext.startsWith('.') ? ext : `.${ext}`, 'text/plain');
            }
        }

        // FIX PERMANEN: Fungsi startDownload yang diperbaiki dan lebih solid
        function startDownload(ext, mime) { /* ... (Kode startDownload dipertahankan dari V14.0) ... */
            const name = prompt('Nama file (tanpa ekstensi):', 'kode-edy-v14');
            if (!name) return showStatus('Simpan file dibatalkan.', 'info');
            
            try {
                const blob = new Blob([cm.getValue()], { type: mime });
                if (navigator.msSaveOrOpenBlob) {
                    navigator.msSaveOrOpenBlob(blob, name + ext);
                    showStatus(`File ${name}${ext} berhasil disimpan! (MS Fallback)`, 'success', 3000);
                    return;
                }

                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.style.display = 'none'; 
                a.href = url;
                a.download = name + ext;
                document.body.appendChild(a);
                
                setTimeout(() => {
                    a.click();
                    document.body.removeChild(a); 
                    URL.revokeObjectURL(url);
                    showStatus(`File ${name}${ext} berhasil disimpan!`, 'success', 3000);
                }, 100); 
            } catch (error) {
                console.error('Download Error:', error);
                showStatus('Gagal menyimpan file. Coba gunakan fitur "Bagikan Text" atau salin manual.', 'error');
            } finally {
                hideAllSubMenus();
            }
        }
        
        async function convertAndDownloadJpg() { /* ... (Kode convertAndDownloadJpg dipertahankan dari V14.0) ... */
            showStatus('Merender Full JPG, mohon tunggu...', 'loading', 0);
            
            const wrap = cm.getWrapperElement();
            const originalScrollTop = cm.getScrollInfo().top;
            const originalHeight = wrap.style.height; 
            
            cm.setOption('viewportMargin', Infinity); 
            cm.refresh(); 
            
            const totalHeight = cm.getScrollInfo().height;
            cm.setSize(null, totalHeight + 'px'); 
            cm.refresh();

            wrap.classList.add('full-render');
            await new Promise(r => setTimeout(r, 100)); 
            
            try {
                const editorBgColor = window.getComputedStyle(wrap).backgroundColor || '#272822';
                
                const canvas = await html2canvas(wrap, {
                    scale: 2, 
                    useCORS: true,
                    backgroundColor: editorBgColor,
                    height: totalHeight,
                    windowHeight: totalHeight,
                    scrollX: -window.scrollX,
                    scrollY: -window.scrollY 
                });
                
                const blob = await new Promise(resolve => canvas.toBlob(resolve, 'image/jpeg', 0.9));
                if (!blob) throw new Error('Blob creation failed');
                
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `full-code-v14-${Date.now()}.jpg`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                showStatus('Full JPG berhasil diunduh!', 'success');
            } catch (e) {
                console.error('JPG Error:', e);
                showStatus('Gagal membuat Full JPG: ' + (e.message || 'Terjadi kesalahan saat rendering.'), 'error');
            } finally {
                wrap.classList.remove('full-render');
                cm.setOption('viewportMargin', 50); 
                cm.setSize(null, originalHeight || 'auto'); 
                cm.scrollTo(0, originalScrollTop);
                cm.refresh();
                hideAllSubMenus();
            }
        }
        
        async function shareAsText() { /* ... (Kode shareAsText dipertahankan) ... */
            const code = cm.getValue();
            const shareData = {
                title: 'Kode dari Edy Sahputra V14.1',
                text: `Kode dari All-in-One Dev Editor V14.1:\n\n${code}`
            };
            try {
                if (navigator.canShare && navigator.canShare(shareData)) {
                    await navigator.share(shareData);
                    showStatus('Berbagi teks berhasil!', 'success');
                } else {
                    await navigator.clipboard.writeText(shareData.text);
                    showStatus('Berbagi tidak didukung. Kode disalin ke clipboard!', 'info');
                }
            } catch (e) {
                if (e.name !== 'AbortError') showStatus('Berbagi dibatalkan/gagal.', 'error');
            }
            hideAllSubMenus();
        }

        // --- LOGIKA PWA UPDATE NOTIFICATION & INSTALL PROMPT (Dipertahankan) ---
        let deferredPrompt;
        const installContainer = document.getElementById('install-container');
        const installButton = document.getElementById('install-button');
        let newWorker;
        const notification = document.getElementById('updateNotification'); 
        const reloadButton = document.getElementById('reloadButton');

        function showUpdateNotification() {
            notification.style.display = 'flex';
            reloadButton.addEventListener('click', () => {
                newWorker.postMessage({ action: 'skipWaiting' });
            });
        }
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.getRegistration('service-worker.js').then(reg => {
                if (reg && reg.waiting) {
                    newWorker = reg.waiting;
                    showUpdateNotification();
                    return;
                }
                if (reg) {
                    reg.addEventListener('updatefound', () => {
                        newWorker = reg.installing;
                        newWorker.addEventListener('statechange', () => {
                            if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                showUpdateNotification();
                            }
                        });
                    });
                }
            });
            let refreshing;
            navigator.serviceWorker.addEventListener('controllerchange', () => {
                if (refreshing) return;
                window.location.reload();
                refreshing = true;
            });
        }
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            installContainer.classList.remove('hidden');
            installContainer.style.display = 'flex'; 
        });
        installButton.addEventListener('click', async () => {
            installContainer.classList.add('hidden');
            installContainer.style.display = 'none';
            if (deferredPrompt) {
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                console.log(`Respons pengguna: ${outcome}`);
                deferredPrompt = null;
            }
        });
        window.addEventListener('appinstalled', () => {
            console.log('Aplikasi berhasil di-install!');
            installContainer.classList.add('hidden');
            installContainer.style.display = 'none';
            deferredPrompt = null;
        });

    </script>
    
</body>
</html>