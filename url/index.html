<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pembaca File v9 (Split Preview - Debug Focus)</title>
    <style>
        /* Reset dasar dan box-sizing */
        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
        html { font-size: 16px; }
        body { font-family: system-ui, sans-serif; line-height: 1.6; background-color: #f0f2f5; color: #333; padding: 10px; min-height: 100vh; }
        .container { max-width: 900px; width: 100%; margin: 20px auto; background-color: #fff; padding: 25px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); overflow: hidden; }
        h1, h2 { color: #1d3557; border-bottom: 2px solid #e9ecef; padding-bottom: 10px; margin-bottom: 20px; }
        h1 { font-size: 1.8rem; text-align: center; }
        h2 { font-size: 1.4rem; margin-top: 30px; }

        /* File Input */
        .file-label { display: block; margin-bottom: 25px; font-weight: 600; cursor: pointer; background-color: #6c757d; /* Grey initially */ color: white; padding: 12px 20px; border-radius: 5px; text-align: center; transition: background-color 0.3s ease; border: none; font-size: 1rem; }
        .file-label.ready { background-color: #457b9d; } /* Blue when ready */
        .file-label.ready:hover { background-color: #1d3557; }
        #fileInput { display: none; }

        /* Output Area */
        #outputArea { margin-top: 20px; min-height: 50px; }
        #initialMessage { text-align: center; color: #6c757d; font-style: italic; margin-bottom: 20px; }

        /* Status/Error Styling */
        .status-message { font-weight: 500; padding: 12px 15px; border-radius: 5px; margin-bottom: 20px; border: 1px solid transparent; text-align: center; }
        .status-message.processing { background-color: #e9ecef; color: #495057; border-color: #ced4da; }
        .status-message.error { background-color: #f8d7da; color: #721c24; border-color: #f5c6cb; }
        .status-message.warning { background-color: #fff3cd; color: #856404; border-color: #ffeeba; }
        .status-message.success { background-color: #d4edda; color: #155724; border-color: #c3e6cb; }

        /* Section Styling */
        .section { margin-top: 30px; padding-top: 25px; border-top: 1px solid #e9ecef; }
        #fileInfo p, #dataSection p { margin-bottom: 10px; word-wrap: break-word; }
        #fileInfo code, #dataContentOutput { background-color: #f8f9fa; padding: 4px 8px; border-radius: 4px; border: 1px solid #dee2e6; font-family: "SFMono-Regular", Consolas, monospace; word-break: break-all; font-size: 0.9em; color: #495057; display: inline-block; max-width: 100%; white-space: pre-wrap; }
        #dataContentOutput { display: block; width: 100%; min-height: 150px; max-height: 400px; padding: 12px; margin-top: 10px; resize: vertical; white-space: pre-wrap; overflow-wrap: break-word; }

        /* Preview Iframe Container */
        #previewSection { border-top: 2px dashed #adb5bd; } /* Visually separate */
        #previewContainer { margin-top: 15px; height: 450px; border: 1px solid #ccc; border-radius: 4px; overflow: hidden; background-color: #e9ecef; /* Placeholder bg */ position: relative; }
        #previewFrame { width: 100%; height: 100%; border: none; display: block; }

        /* Buttons */
        .button-group { margin-top: 15px; display: flex; flex-wrap: wrap; gap: 10px; }
        .action-button { color: white; border: none; padding: 10px 18px; border-radius: 5px; cursor: pointer; font-size: 0.95em; transition: all 0.2s ease; font-weight: 500; flex-grow: 1; min-width: 150px; }
        .action-button:hover { opacity: 0.85; }
        .action-button:active { transform: scale(0.98); }
        .action-button:disabled { background-color: #adb5bd !important; cursor: not-allowed; transform: none; opacity: 0.7; }
        #copyDataButton { background-color: #2a9d8f; } #copyDataButton:hover { background-color: #264653; }
        #createBlobLinkButton { background-color: #007bff; } #createBlobLinkButton:hover { background-color: #0056b3; }

        /* Blob URL Result Area */
        #blobUrlResultArea { margin-top: 15px; padding: 15px; border: 1px dashed #ced4da; border-radius: 5px; background-color: #f8f9fa; }
        #blobUrlResultArea p { margin-bottom: 8px; font-size: 0.95em; }
        #blobUrlResultArea strong { color: #dc3545; font-weight: 600; }
        #blobUrlResultArea a { display: block; margin-top: 10px; padding: 10px 15px; background-color: #28a745; color: white; text-decoration: none; border-radius: 4px; font-weight: 500; transition: background-color 0.2s ease; text-align: center; }
        #blobUrlResultArea a:hover { background-color: #218838; }
        #blobUrlResultArea code { font-size: 0.85em; word-break: break-all; color: #6c757d; background: #e9ecef; padding: 2px 4px; }
        #blobUrlResultArea:empty { display: none; } /* Keep hidden when empty */

        /* Responsive */
        @media (max-width: 768px) { .container { padding: 20px; margin: 15px auto; } h1 { font-size: 1.6rem; } h2 { font-size: 1.25rem; } #previewContainer { height: 400px; } .action-button { min-width: 120px; } }
        @media (max-width: 480px) { .container { padding: 15px; margin: 10px auto; } h1 { font-size: 1.4rem; } h2 { font-size: 1.15rem; } #fileInfo p, #dataSection p { font-size: 0.95rem; } #fileInfo code, #dataContentOutput { font-size: 0.88em; } .button-group { flex-direction: column; } .action-button { width: 100%; } #previewContainer { height: 350px; } }
    </style>
</head>
<body>

    <div class="container">
        <h1>Pembaca File v9 (Split Preview - Debug Focus)</h1>

        <label for="fileInput" class="file-label" id="fileLabel">Menunggu Pratinjau Siap...</label>
        <input type="file" id="fileInput" disabled> <!-- Start disabled -->

        <div id="outputArea">
            <p id="initialMessage">Pilih file setelah pratinjau siap untuk melihat info & konten.</p>
            <!-- Sections dynamically added here -->
        </div>

        <!-- Preview Section with Iframe -->
        <div class="section" id="previewSection">
             <h2>Pratinjau File</h2>
             <div id="previewContainer">
                 <iframe id="previewFrame" src="https://edycindy.github.io/-/url/preview.html" title="Pratinjau File"></iframe>
             </div>
        </div>
        <!-- End Preview Section -->

    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            console.log("INDEX v9 Script: Initializing.");

            // --- DOM Elements ---
            const fileInput = document.getElementById('fileInput');
            const fileLabel = document.getElementById('fileLabel');
            const outputArea = document.getElementById('outputArea');
            const initialMessage = document.getElementById('initialMessage');
            const previewFrame = document.getElementById('previewFrame');
            const previewSection = document.getElementById('previewSection');

            // --- State Variables ---
            const MAX_FILE_SIZE_MB = 50;
            const MAX_FILE_SIZE_BYTES = MAX_FILE_SIZE_MB * 1024 * 1024;
            let currentBlobUrl = null;
            let currentFile = null;
            let isPreviewReady = false;
            const previewFrameOrigin = '*'; // Use '*' for file://, specify in production

            // --- Initial Check ---
            if (!fileInput || !outputArea || !previewFrame || !previewSection || !fileLabel || !initialMessage) {
                console.error("INDEX v9: Critical UI elements missing. Aborting.");
                outputArea.innerHTML = '<div class="status-message error">Error Kritis: Komponen UI hilang. Refresh halaman mungkin membantu.</div>';
                if(previewSection) previewSection.style.display = 'none';
                return;
            }

             // --- Event Listeners ---
            fileInput.addEventListener('change', handleFileSelect);
            window.addEventListener('message', handleIframeMessage);
            console.log("INDEX v9: Event listeners added.");

             // --- Iframe Message Handler ---
             function handleIframeMessage(event) {
                console.log(`INDEX v9: Message received. Origin: ${event.origin}`); // Log all messages

                 // Basic security check: Is the message from our iframe?
                 if (event.source !== previewFrame.contentWindow) {
                      console.log("INDEX v9: Message ignored (not from preview frame).");
                      return;
                 }
                 // More specific origin check (recommended for production)
                 // if (previewFrameOrigin !== '*' && event.origin !== previewFrameOrigin) {
                 //      console.warn(`INDEX v9: Message rejected from unexpected origin: ${event.origin}. Expected: ${previewFrameOrigin}`);
                 //      return;
                 // }

                 const message = event.data;
                 console.log("INDEX v9: Message data from iframe:", message); // Log the data itself

                 if (message && message.type === 'previewReady') {
                     console.log("INDEX v9: Received 'previewReady' confirmation from iframe.");
                     if (!isPreviewReady) { // Prevent multiple activations
                          isPreviewReady = true;
                          fileInput.disabled = false; // Enable file input
                          fileLabel.textContent = "Pilih File...";
                          fileLabel.classList.add('ready'); // Change style to indicate ready
                          initialMessage.textContent = "Pratinjau siap. Pilih file untuk memulai.";
                          console.log("INDEX v9: File input enabled.");
                     } else {
                           console.log("INDEX v9: Received duplicate 'previewReady', ignoring.");
                     }
                 } else if (message && message.type === 'previewError') {
                     console.error("INDEX v9: Received error message from preview frame:", message.payload);
                     // Optionally display this error in the main UI as well
                     outputArea.appendChild(createStatusMessage('error', `Error di Pratinjau: ${escapeHtml(message.payload)}`));
                 } else {
                     console.log("INDEX v9: Received unhandled message type from iframe:", message?.type);
                 }
             }

             // --- Main File Handler ---
            async function handleFileSelect(event) {
                console.log("INDEX v9: handleFileSelect triggered.");

                // 1. Reset UI and State (keep initial message if nothing else is added)
                clearPreviousState(); // Clears outputArea except initial msg, revokes blob, clears preview
                outputArea.appendChild(createStatusMessage('processing', 'Memproses file...'));
                currentFile = event.target.files[0];
                fileInput.value = null; // Reset file input

                // 2. No File Selected
                if (!currentFile) {
                    console.log("INDEX v9: No file selected.");
                    clearProcessingMessage();
                    outputArea.appendChild(createStatusMessage('warning', 'Tidak ada file yang dipilih.'));
                    postToPreview({ type: 'clearPreview' }); // Ensure preview is cleared
                    return;
                }

                console.log(`INDEX v9: File selected: ${currentFile.name}, Size: ${currentFile.size}, Type: ${currentFile.type}`);

                 // 3. File Size Check
                 if (currentFile.size > MAX_FILE_SIZE_BYTES) {
                     const errorMsg = `File terlalu besar (${formatBytes(currentFile.size)}). Batas: ${MAX_FILE_SIZE_MB} MB.`;
                     console.warn("INDEX v9: " + errorMsg);
                     clearPreviousState();
                     outputArea.appendChild(createStatusMessage('warning', errorMsg + " Hanya info ditampilkan."));
                     outputArea.appendChild(createFileInfoSection(currentFile));
                     postToPreview({ type: 'showStatus', payload: { message: errorMsg, isError: true } });
                     currentFile = null;
                     return;
                 }

                 // 4. Read File Content
                 try {
                    console.time("INDEX v9: FileRead"); // Start timer
                    const { data, readMethod } = await readFileContent(currentFile);
                    console.timeEnd("INDEX v9: FileRead"); // End timer

                    if (data === null || typeof data === 'undefined') {
                        // This case should ideally be caught by reader.onerror, but double-check
                        throw new Error("Hasil pembacaan file kosong atau tidak terdefinisi.");
                    }

                    const dataStart = (typeof data === 'string') ? data.substring(0, 100) : '[Non-string data]';
                    console.log(`INDEX v9: File read successfully (Method: ${readMethod}). Data starts with: ${dataStart}...`);

                     // 5. Update Main UI
                     clearProcessingMessage();
                     outputArea.appendChild(createFileInfoSection(currentFile));
                     outputArea.appendChild(createDataSection(data, readMethod));
                     setupActionButtons();

                     // 6. Send Data to Preview Iframe
                     console.log(`INDEX v9: Checking if preview is ready (isPreviewReady = ${isPreviewReady}) before sending render command.`);
                     if (isPreviewReady) {
                          console.log("INDEX v9: Preview is ready. Sending 'renderPreview' message.");
                          postToPreview({
                              type: 'renderPreview',
                              payload: {
                                  fileData: data,
                                  fileType: currentFile.type || 'application/octet-stream',
                                  fileName: currentFile.name
                              }
                          });
                     } else {
                          console.warn("INDEX v9: Preview frame is not ready yet. Cannot send render command.");
                           // Send a status message to the preview instead? It might display this when it becomes ready.
                           postToPreview({ type: 'showStatus', payload: { message: 'Halaman utama memproses file, tetapi pratinjau belum siap menerima data.', isError: false } });
                     }

                 } catch (error) {
                     console.error("INDEX v9: Error during file processing pipeline:", error);
                     clearPreviousState(); // Clear partial UI updates
                     const errorText = `Gagal memproses file: ${escapeHtml(error.message || 'Unknown error')}`;
                     outputArea.appendChild(createStatusMessage('error', errorText));
                     // Try sending error status to preview even if it might not be ready
                     postToPreview({ type: 'showStatus', payload: { message: `Error di halaman utama: ${errorText}`, isError: true } });
                     currentFile = null;
                 }
            }

            // --- File Reading (No changes from v8, just added logging) ---
            function readFileContent(file) {
                 console.log(`INDEX v9: readFileContent called for ${file.name}.`);
                 return new Promise((resolve, reject) => {
                     const reader = new FileReader();
                     const fileType = file.type;
                     let readMethod = 'DataURL';
                     if (fileType.startsWith('text/')) { readMethod = 'Text'; }
                     // Add other conditions if needed, default remains DataURL

                     console.log(`INDEX v9: Determined read method: ${readMethod}`);

                     reader.onload = (e) => {
                          console.log(`INDEX v9: FileReader onload (Method: ${readMethod}).`);
                          if (e.target && typeof e.target.result !== 'undefined' && e.target.result !== null) {
                              if(readMethod === 'DataURL' && typeof e.target.result === 'string' && !e.target.result.startsWith('data:')) {
                                 console.error("INDEX v9: Invalid DataURL format detected in onload.");
                                 reject(new Error("Format Data URL tidak valid."));
                              } else {
                                 resolve({ data: e.target.result, readMethod: readMethod });
                              }
                          } else {
                              console.error("INDEX v9: FileReader result is invalid in onload.");
                              reject(new Error("Hasil pembacaan file tidak valid."));
                          }
                     };
                     reader.onerror = (e) => {
                         console.error("INDEX v9: FileReader onerror:", e.target.error);
                         reject(new Error(`Gagal membaca file: ${e.target.error?.name || 'Unknown error'}`));
                     };
                     reader.onabort = () => {
                         console.warn("INDEX v9: FileReader onabort.");
                         reject(new Error("Pembacaan file dibatalkan."));
                     };

                     try {
                          console.log(`INDEX v9: Starting FileReader.readAs${readMethod}()...`);
                          if (readMethod === 'Text') { reader.readAsText(file); }
                          else { reader.readAsDataURL(file); }
                     } catch (err) {
                          console.error(`INDEX v9: Error initiating FileReader.readAs${readMethod}():`, err);
                          reject(new Error(`Gagal memulai pembacaan file (${readMethod}).`));
                     }
                 });
             }

            // --- UI Creation Functions (Minor text changes) ---
            function createFileInfoSection(file) {
                const div = document.createElement('div');
                div.id = 'fileInfo'; div.classList.add('section');
                div.innerHTML = `<h2>Informasi File</h2><p><strong>Nama:</strong> <code>${escapeHtml(file.name)}</code></p><p><strong>Ukuran:</strong> ${formatBytes(file.size)}</p><p><strong>Tipe:</strong> <code>${escapeHtml(file.type) || 'Tidak diketahui'}</code></p><p><strong>Modifikasi:</strong> ${file.lastModifiedDate ? file.lastModifiedDate.toLocaleString('id-ID') : 'N/A'}</p>`;
                return div;
            }
            function createDataSection(data, readMethod) {
                 const div = document.createElement('div');
                 div.id = 'dataSection'; div.classList.add('section');
                 const title = readMethod === 'Text' ? 'Konten Teks' : 'Data URL';
                 const description = readMethod === 'Text' ? 'Isi teks dari file.' : 'Representasi Base64 dari file (Data URL).';
                 div.innerHTML = `<h2>${title} & Tautan Lokal</h2><p>${description}</p><textarea id="dataContentOutput" readonly>${escapeHtml(data)}</textarea><div class="button-group"><button id="copyDataButton" class="action-button">Salin ${title}</button><button id="createBlobLinkButton" class="action-button">Buat Tautan Unduh</button></div><div id="blobUrlResultArea" aria-live="polite"></div>`;
                 return div;
            }
             function createStatusMessage(type, message) {
                 const div = document.createElement('div');
                 div.className = `status-message ${type}`;
                 div.textContent = message;
                 return div;
             }

            // --- Action Button Setup (Unchanged) ---
             function setupActionButtons() {
                 const copyBtn = document.getElementById('copyDataButton');
                 const blobBtn = document.getElementById('createBlobLinkButton');
                 if (copyBtn) copyBtn.addEventListener('click', handleCopyData);
                 if (blobBtn) blobBtn.addEventListener('click', handleCreateBlobLink);
                 console.log("INDEX v9: Action button listeners attached.");
             }

            // --- Button Handlers (Minor logging changes) ---
             function handleCopyData(event) {
                 console.log("INDEX v9: handleCopyData called.");
                 const button = event.target;
                 const dataOutput = document.getElementById('dataContentOutput');
                 if (dataOutput) copyToClipboard(dataOutput.value, button);
                 else console.error("INDEX v9: #dataContentOutput not found for copying.");
             }
             function handleCreateBlobLink(event) {
                 console.log("INDEX v9: handleCreateBlobLink called.");
                 const button = event.target; button.disabled = true;
                 const dataOutput = document.getElementById('dataContentOutput');
                 const blobResultArea = document.getElementById('blobUrlResultArea');
                 if (!dataOutput || !blobResultArea) { console.error("INDEX v9: Missing elements for Blob creation."); if(blobResultArea) blobResultArea.innerHTML = `<p class="status-message error">Error UI.</p>`; button.disabled = false; return; }
                 if (!currentFile) { console.error("INDEX v9: Cannot create Blob, currentFile is null."); blobResultArea.innerHTML = `<p class="status-message error">File info hilang.</p>`; button.disabled = false; return; }
                 const content = dataOutput.value;
                 if (!content) { console.error("INDEX v9: Blob content is empty."); blobResultArea.innerHTML = `<p class="status-message error">Konten kosong.</p>`; button.disabled = false; return; }
                 blobResultArea.innerHTML = `<p class="status-message processing">Membuat Blob URL...</p>`;
                 setTimeout(() => { /* Blob creation logic (unchanged from v8) */
                     try {
                         let blob;
                         if (content.startsWith('data:') && content.includes(',')) {
                             blob = dataURLtoBlob(content); if (!blob) throw new Error("Konversi Data URL ke Blob gagal.");
                         } else {
                             const mimeType = currentFile.type || 'application/octet-stream'; blob = new Blob([content], { type: mimeType });
                         }
                         console.log(`INDEX v9: Blob created: Type=${blob.type}, Size=${blob.size}`);
                         revokeCurrentBlobUrl(); currentBlobUrl = URL.createObjectURL(blob);
                         console.log(`INDEX v9: Blob URL: ${currentBlobUrl}`);
                         blobResultArea.innerHTML = `<p class="status-message success">Tautan unduh lokal (Blob URL) siap:</p><p><strong>PENTING:</strong> Tautan ini <strong>sementara</strong> & hanya untuk browser ini.</p><a href="${currentBlobUrl}" download="${escapeHtml(currentFile.name || 'download')}" title="Unduh ${escapeHtml(currentFile.name)}">Unduh File (${escapeHtml(currentFile.name || 'file')})</a><p style="margin-top:10px;"><small>URL: <code>${currentBlobUrl}</code></small></p>`;
                     } catch (error) {
                         console.error("INDEX v9: Error creating Blob URL:", error); revokeCurrentBlobUrl();
                         blobResultArea.innerHTML = `<p class="status-message error">Gagal membuat tautan: ${escapeHtml(error.message)}</p>`;
                     } finally { button.disabled = false; }
                 }, 10);
             }

            // --- Helper Functions ---
            function postToPreview(message) {
                 if (!previewFrame || !previewFrame.contentWindow) { console.error("INDEX v9: Preview frame not available for postMessage."); return; }
                 console.log(`INDEX v9: Attempting to post message to preview (Ready: ${isPreviewReady}):`, message);
                 // We attempt to send anyway, the preview frame might buffer or handle it upon becoming ready.
                 // The critical part is renderPreview, which should ideally only be sent when isPreviewReady is true.
                  if (!isPreviewReady && message.type === 'renderPreview') {
                       console.warn("INDEX v9: Holding back 'renderPreview' because iframe is not confirmed ready.");
                       // Optionally, queue the message here instead of just warning
                       // previewMessageQueue.push(message); // Example queue
                       postToPreview({ type: 'showStatus', payload: { message: 'Menunggu pratinjau siap menerima data render...', isError: false } });
                       return; // Don't send the render message yet
                  }

                 try {
                     previewFrame.contentWindow.postMessage(message, previewFrameOrigin);
                     console.log("INDEX v9: Message sent successfully.");
                 } catch (e) { console.error("INDEX v9: Error sending postMessage:", e); }
             }
             function clearPreviousState() {
                 console.log("INDEX v9: Clearing previous state.");
                 revokeCurrentBlobUrl();
                 // Clear dynamic content, keep initial message
                 outputArea.innerHTML = '';
                 outputArea.appendChild(initialMessage);
                 currentFile = null;
                 // Don't reset isPreviewReady here
                 postToPreview({ type: 'clearPreview' });
             }
            function clearProcessingMessage() {
                 const processingMsg = outputArea.querySelector('.status-message.processing');
                 if (processingMsg) { processingMsg.remove(); console.log("INDEX v9: Processing message removed."); }
            }
             function revokeCurrentBlobUrl() { if (currentBlobUrl) { console.log(`INDEX v9: Revoking Blob URL: ${currentBlobUrl}`); URL.revokeObjectURL(currentBlobUrl); currentBlobUrl = null; const area = document.getElementById('blobUrlResultArea'); if (area) area.innerHTML = ''; } }
            function dataURLtoBlob(dataurl) { /* Unchanged from v8 */
                 if (!dataurl || typeof dataurl !== 'string' || !dataurl.startsWith('data:') || !dataurl.includes(',')) { console.error("INDEX v9: Invalid DataURL format for Blob conversion."); return null; }
                 try {
                     const arr = dataurl.split(','); const mimeMatch = arr[0].match(/:(.*?)(?:;base64)?$/i); const mime = mimeMatch && mimeMatch[1] ? mimeMatch[1] : 'application/octet-stream'; const base64Data = arr[1];
                     if (!/^[A-Za-z0-9+/]*={0,2}$/.test(base64Data) || base64Data.length % 4 !== 0) { console.warn("INDEX v9: Potentially invalid Base64 data in DataURL."); }
                     const byteString = atob(base64Data); const ab = new ArrayBuffer(byteString.length); const ia = new Uint8Array(ab);
                     for (let i = 0; i < byteString.length; i++) { ia[i] = byteString.charCodeAt(i); }
                     return new Blob([ab], { type: mime });
                 } catch (e) { console.error("INDEX v9: Error in dataURLtoBlob:", e); return null; }
            }
            function copyToClipboard(textToCopy, buttonElement) { /* Unchanged from v8 */
                if (!navigator.clipboard) { alert('Fitur salin otomatis tidak didukung/diizinkan.'); return; }
                if (!textToCopy) { console.warn("INDEX v9: No text to copy."); return; }
                const originalText = buttonElement.textContent; buttonElement.disabled = true; buttonElement.textContent = 'Menyalin...';
                navigator.clipboard.writeText(textToCopy).then(() => {
                    console.log("INDEX v9: Text copied."); buttonElement.textContent = 'Disalin!';
                    setTimeout(() => { buttonElement.textContent = originalText; buttonElement.disabled = false; }, 2000);
                }).catch(err => {
                    console.error('INDEX v9: Copy failed: ', err); buttonElement.textContent = 'Gagal!'; alert('Gagal menyalin.');
                    setTimeout(() => { buttonElement.textContent = originalText; buttonElement.disabled = false; }, 2500);
                });
             }
             function formatBytes(bytes, decimals = 2) { /* Unchanged from v8 */
                if (!+bytes || bytes < 0) return '0 Bytes'; const k = 1024; const dm = decimals < 0 ? 0 : decimals; const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB', 'PB']; const i = Math.floor(Math.log(bytes) / Math.log(k)); const index = Math.min(i, sizes.length - 1); return `${parseFloat((bytes / Math.pow(k, index)).toFixed(dm))} ${sizes[index]}`;
             }
             function escapeHtml(unsafe) { /* Unchanged from v8 */
                 if (typeof unsafe !== 'string') { try { return String(unsafe); } catch (e) { return '';} }
                 return unsafe.replace(/&/g, "&").replace(/</g, "<").replace(/>/g, ">").replace(/"/g, "\"").replace(/'/g, "'");
             }

            console.log("INDEX v9 Script: Initialization complete. Waiting for iframe 'previewReady' message.");

        }); // End DOMContentLoaded
    </script>

</body>
</html>
