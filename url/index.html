<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pembaca File v11 (Iframe Preview)</title>
    <style>
        /* Reset dasar dan box-sizing */
        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
        html { font-size: 16px; scroll-behavior: smooth; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            line-height: 1.6; background-color: #f0f2f5; color: #333;
            padding: 10px; min-height: 100vh;
        }
        .container {
            max-width: 900px; width: 100%; margin: 20px auto; background-color: #fff;
            padding: 25px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        h1, h2 {
            color: #1d3557; border-bottom: 2px solid #e9ecef;
            padding-bottom: 10px; margin-bottom: 20px;
        }
        h1 { font-size: 1.8rem; text-align: center; }
        h2 { font-size: 1.4rem; margin-top: 30px; }

        /* File Input */
        .file-label {
            display: block; margin-bottom: 25px; font-weight: 600; cursor: pointer;
            background-color: #6c757d; /* Grey initially */ color: white; padding: 12px 20px;
            border-radius: 5px; text-align: center; transition: background-color 0.3s ease;
            border: none; font-size: 1rem;
        }
        .file-label.ready { background-color: #457b9d; } /* Blue when ready */
        .file-label.ready:hover { background-color: #1d3557; }
        #fileInput { display: none; }

        /* Output Area */
        #outputArea { margin-top: 20px; min-height: 50px; }
        #initialMessage { text-align: center; color: #6c757d; font-style: italic; margin-bottom: 20px; }

        /* Status/Error Styling */
        .status-message { font-weight: 500; padding: 12px 15px; border-radius: 5px; margin-bottom: 20px; border: 1px solid transparent; text-align: center; }
        .status-message.processing { background-color: #e9ecef; color: #495057; border-color: #ced4da; }
        .status-message.error { background-color: #f8d7da; color: #721c24; border-color: #f5c6cb; }
        .status-message.warning { background-color: #fff3cd; color: #856404; border-color: #ffeeba; }
        .status-message.success { background-color: #d4edda; color: #155724; border-color: #c3e6cb; }

        /* Section Styling */
        .section { margin-top: 30px; padding-top: 25px; border-top: 1px solid #e9ecef; }
        #fileInfo p, #dataSection p { margin-bottom: 10px; word-wrap: break-word; overflow-wrap: break-word; }
        #fileInfo code, #dataContentOutput {
            background-color: #f8f9fa; padding: 4px 8px; border-radius: 4px;
            border: 1px solid #dee2e6; font-family: "SFMono-Regular", Consolas, monospace;
            word-break: break-all; font-size: 0.9em; color: #495057; display: inline-block;
            max-width: 100%; white-space: pre-wrap;
        }
        #dataContentOutput {
            display: block; width: 100%; min-height: 150px; max-height: 400px;
            padding: 12px; margin-top: 10px; resize: vertical;
            white-space: pre-wrap; overflow-wrap: break-word;
        }

        /* Preview Iframe Container */
        #previewSection { border-top: 2px dashed #adb5bd; }
        #previewContainer {
            margin-top: 15px; height: 450px; border: 1px solid #ccc;
            border-radius: 4px; overflow: hidden; background-color: #e9ecef; /* Placeholder bg */
            position: relative; /* For potential overlays */
        }
        #previewFrame { width: 100%; height: 100%; border: none; display: block; }

        /* Buttons */
        .button-group { margin-top: 15px; display: flex; flex-wrap: wrap; gap: 10px; }
        .action-button { color: white; border: none; padding: 10px 18px; border-radius: 5px; cursor: pointer; font-size: 0.95em; transition: all 0.2s ease; font-weight: 500; flex-grow: 1; min-width: 150px; }
        .action-button:hover { opacity: 0.85; }
        .action-button:active { transform: scale(0.98); }
        .action-button:disabled { background-color: #adb5bd !important; cursor: not-allowed; opacity: 0.7; }
        #copyDataButton { background-color: #2a9d8f; } #copyDataButton:hover { background-color: #264653; }
        #createBlobLinkButton { background-color: #007bff; } #createBlobLinkButton:hover { background-color: #0056b3; }

        /* Blob URL Result Area */
        #blobUrlResultArea { margin-top: 15px; padding: 15px; border: 1px dashed #ced4da; border-radius: 5px; background-color: #f8f9fa; }
        #blobUrlResultArea p { margin-bottom: 8px; font-size: 0.95em; }
        #blobUrlResultArea strong { color: #dc3545; font-weight: 600; }
        #blobUrlResultArea a { display: block; margin-top: 10px; padding: 10px 15px; background-color: #28a745; color: white; text-decoration: none; border-radius: 4px; font-weight: 500; transition: background-color 0.2s ease; text-align: center; }
        #blobUrlResultArea a:hover { background-color: #218838; }
        #blobUrlResultArea code { font-size: 0.85em; word-break: break-all; color: #6c757d; background: #e9ecef; padding: 2px 4px; }
        #blobUrlResultArea:empty { display: none; }

        /* Responsive */
        @media (max-width: 768px) { .container { padding: 20px; margin: 15px auto; } h1 { font-size: 1.6rem; } h2 { font-size: 1.25rem; } #previewContainer { height: 400px; } .action-button { min-width: 120px; } }
        @media (max-width: 480px) { .container { padding: 15px; margin: 10px auto; } h1 { font-size: 1.4rem; } h2 { font-size: 1.15rem; } #fileInfo p, #dataSection p { font-size: 0.95rem; } #fileInfo code, #dataContentOutput { font-size: 0.88em; } .button-group { flex-direction: column; } .action-button { width: 100%; } #previewContainer { height: 350px; } }
    </style>
</head>
<body>

    <div class="container">
        <h1>Pembaca File v11 (Iframe Preview)</h1>

        <label for="fileInput" class="file-label" id="fileLabel">Menunggu Pratinjau Siap...</label>
        <input type="file" id="fileInput" disabled> <!-- Start disabled -->

        <div id="outputArea">
            <p id="initialMessage">Pilih file setelah pratinjau siap untuk melihat info & konten.</p>
            <!-- Sections dynamically added here: #fileInfo, #dataSection -->
        </div>

        <!-- Preview Section with Iframe -->
        <div class="section" id="previewSection">
             <h2>Pratinjau File</h2>
             <div id="previewContainer">
                 <!-- The iframe source MUST be correct relative to index.html -->
                 <!-- For GitHub Pages, if both files are in root, this is fine -->
                 <iframe id="previewFrame" src="https://github.com/EDYCINDY/-/blob/main/url/preview.html" title="Pratinjau File"></iframe>
             </div>
        </div>
        <!-- End Preview Section -->

    </div>

    <script>
        // --- SCRIPT for index.html (v11) ---
        document.addEventListener('DOMContentLoaded', () => {
            console.log("INDEX v11 Script: Initializing.");

            // --- DOM Elements ---
            const fileInput = document.getElementById('fileInput');
            const fileLabel = document.getElementById('fileLabel');
            const outputArea = document.getElementById('outputArea');
            const initialMessage = document.getElementById('initialMessage');
            const previewFrame = document.getElementById('previewFrame');
            const previewSection = document.getElementById('previewSection');

            // --- State Variables ---
            const MAX_FILE_SIZE_MB = 50;
            const MAX_FILE_SIZE_BYTES = MAX_FILE_SIZE_MB * 1024 * 1024;
            let currentBlobUrl = null;
            let currentFile = null;
            let isPreviewReady = false;
            // IMPORTANT: Set this to your GitHub Pages URL in production
            // e.g., const previewFrameOrigin = 'https://github.com/EDYCINDY/-/blob/main/url/preview.html';
            const previewFrameOrigin = '*'; // Use '*' for local file testing and initial GH Pages setup

            // --- Initial Check ---
            if (!fileInput || !outputArea || !previewFrame || !previewSection || !fileLabel || !initialMessage) {
                console.error("INDEX v11: Critical UI elements missing. Aborting.");
                outputArea.innerHTML = '<p class="status-message error">Error Kritis: Komponen UI hilang. Refresh halaman mungkin membantu.</p>';
                if(previewSection) previewSection.style.display = 'none';
                return;
            }

             // --- Event Listeners ---
            fileInput.addEventListener('change', handleFileSelect);
            window.addEventListener('message', handleIframeMessage);
            console.log("INDEX v11: Event listeners added.");

             // --- Iframe Message Handler ---
             function handleIframeMessage(event) {
                 // Security Check (Looser for local/GH Pages initial test, stricter for production)
                 if (previewFrameOrigin !== '*' && event.origin !== previewFrameOrigin) {
                      console.warn(`INDEX v11: Message rejected from unexpected origin: ${event.origin}. Expected: ${previewFrameOrigin}`);
                      return;
                 }
                 // Ensure message is from the iframe, not somewhere else
                 if (event.source !== previewFrame.contentWindow) {
                      console.log("INDEX v11: Message ignored (not from preview frame).");
                      return;
                 }

                 const message = event.data;
                 console.log("INDEX v11: Message data received from iframe:", message);

                 if (message && message.type === 'previewReady') {
                     console.log("INDEX v11: Received 'previewReady' confirmation.");
                     if (!isPreviewReady) {
                          isPreviewReady = true;
                          fileInput.disabled = false;
                          fileLabel.textContent = "Pilih File...";
                          fileLabel.classList.add('ready');
                          initialMessage.textContent = "Pratinjau siap. Pilih file untuk memulai.";
                          console.log("INDEX v11: File input enabled.");
                     }
                 } else if (message && message.type === 'previewError') {
                     console.error("INDEX v11: Error reported from preview frame:", message.payload);
                     outputArea.appendChild(createStatusMessage('error', `Error di Pratinjau: ${escapeHtml(message.payload)}`));
                 } else {
                     console.log("INDEX v11: Received unhandled message type from iframe:", message?.type);
                 }
             }

             // --- Main File Handler ---
            async function handleFileSelect(event) {
                console.log("INDEX v11: handleFileSelect triggered.");

                clearPreviousState();
                outputArea.appendChild(createStatusMessage('processing', 'Memproses file...'));
                currentFile = event.target.files[0];
                fileInput.value = null;

                if (!currentFile) {
                    console.log("INDEX v11: No file selected.");
                    clearProcessingMessage();
                    outputArea.appendChild(createStatusMessage('warning', 'Tidak ada file yang dipilih.'));
                    postToPreview({ type: 'clearPreview' });
                    return;
                }

                console.log(`INDEX v11: File selected: ${currentFile.name}, Size: ${currentFile.size}, Type: ${currentFile.type}`);

                 if (currentFile.size > MAX_FILE_SIZE_BYTES) {
                     const errorMsg = `File terlalu besar (${formatBytes(currentFile.size)}). Batas: ${MAX_FILE_SIZE_MB} MB.`;
                     console.warn("INDEX v11: " + errorMsg);
                     clearPreviousState();
                     outputArea.appendChild(createStatusMessage('warning', errorMsg + " Hanya info ditampilkan."));
                     outputArea.appendChild(createFileInfoSection(currentFile));
                     postToPreview({ type: 'showStatus', payload: { message: errorMsg, isError: true } });
                     currentFile = null;
                     return;
                 }

                 outputArea.appendChild(createFileInfoSection(currentFile)); // Show info early

                 try {
                    console.time("INDEX v11: FileRead");
                    const readMethod = (currentFile.type || '').startsWith('text/') ? 'Text' : 'DataURL';
                    const fileContent = await readFileContentAsync(currentFile, readMethod);
                    console.timeEnd("INDEX v11: FileRead");

                    if (fileContent === null) throw new Error("Gagal membaca konten file.");

                    const dataStart = (typeof fileContent === 'string') ? fileContent.substring(0, 70) : '[Binary Data]';
                    console.log(`INDEX v11: File read (Method: ${readMethod}). Data start: ${dataStart}...`);

                    outputArea.appendChild(createDataSection(fileContent, readMethod));
                    setupActionButtons();

                    console.log(`INDEX v11: Checking preview readiness (isPreviewReady = ${isPreviewReady}) before sending.`);
                    if (isPreviewReady) {
                          console.log("INDEX v11: Preview ready, sending 'renderPreview'.");
                          postToPreview({
                              type: 'renderPreview',
                              payload: {
                                  fileData: fileContent,
                                  fileType: currentFile.type || 'application/octet-stream',
                                  fileName: currentFile.name
                              }
                          });
                    } else {
                          console.warn("INDEX v11: Preview frame not confirmed ready. Cannot send render command yet.");
                          postToPreview({ type: 'showStatus', payload: { message: 'Menunggu konfirmasi pratinjau siap...', isError: false } });
                    }

                    clearProcessingMessage();

                 } catch (error) {
                     console.error("INDEX v11: Error during file processing:", error);
                     clearProcessingMessage();
                     outputArea.appendChild(createStatusMessage('error', `Gagal memproses file: ${escapeHtml(error.message || 'Unknown error')}`));
                     postToPreview({ type: 'showStatus', payload: { message: `Error di halaman utama: ${escapeHtml(error.message)}`, isError: true } });
                     currentFile = null;
                 }
            }

            // --- File Reading (Async) ---
            function readFileContentAsync(file, readMethod = 'DataURL') {
                 console.log(`INDEX v11: Reading ${file.name} as ${readMethod}.`);
                 return new Promise((resolve, reject) => {
                     const reader = new FileReader();
                     reader.onload = e => { /* ... includes validation ... */
                         if (e.target?.result !== null && typeof e.target?.result !== 'undefined') {
                            if(readMethod === 'DataURL' && typeof e.target.result === 'string' && !e.target.result.startsWith('data:')){
                                reject(new Error("Format Data URL tidak valid dari reader.")); return;
                            }
                            console.log(`INDEX v11: FileReader success (Method: ${readMethod}).`);
                            resolve(e.target.result);
                         } else { reject(new Error("Hasil pembacaan file tidak valid.")); }
                     };
                     reader.onerror = e => reject(new Error(`Gagal membaca file: ${e.target.error?.name || 'Unknown error'}`));
                     reader.onabort = () => reject(new Error("Pembacaan file dibatalkan."));
                     try {
                         if (readMethod === 'Text') reader.readAsText(file);
                         else reader.readAsDataURL(file);
                     } catch (err) { reject(new Error(`Gagal memulai pembacaan file (${readMethod}).`)); }
                 });
             }

            // --- UI Creation Functions ---
            function createFileInfoSection(file) {
                document.getElementById('fileInfo')?.remove(); // Clear previous
                const div = document.createElement('div'); div.id = 'fileInfo'; div.classList.add('section');
                div.innerHTML = `<h2>Informasi File</h2><p><strong>Nama:</strong> <code>${escapeHtml(file.name)}</code></p><p><strong>Ukuran:</strong> ${formatBytes(file.size)}</p><p><strong>Tipe:</strong> <code>${escapeHtml(file.type) || 'Tidak Diketahui'}</code></p><p><strong>Modifikasi:</strong> ${file.lastModifiedDate ? file.lastModifiedDate.toLocaleString('id-ID') : 'N/A'}</p>`;
                return div;
            }
            function createDataSection(data, readMethod) {
                document.getElementById('dataSection')?.remove(); // Clear previous
                const div = document.createElement('div'); div.id = 'dataSection'; div.classList.add('section');
                const title = readMethod === 'Text' ? 'Konten Teks' : 'Data URL';
                const description = readMethod === 'Text' ? 'Isi teks dari file.' : 'Representasi Base64 dari file (Data URL).';
                div.innerHTML = `<h2>${title} & Tautan Lokal</h2><p>${description}</p><textarea id="dataContentOutput" readonly>${data}</textarea><div class="button-group"><button id="copyDataButton" class="action-button">Salin ${title}</button><button id="createBlobLinkButton" class="action-button">Buat Tautan Unduh</button></div><div id="blobUrlResultArea" aria-live="polite"></div>`;
                return div;
            }
            function createStatusMessage(type, message) {
                 outputArea.querySelectorAll(`.status-message.${type}, .status-message.processing`).forEach(el => el.remove());
                 const div = document.createElement('div'); div.className = `status-message ${type}`; div.textContent = message; return div;
            }

            // --- Action Button Setup ---
             function setupActionButtons() {
                 const copyBtn = document.getElementById('copyDataButton');
                 const blobBtn = document.getElementById('createBlobLinkButton');
                 if (copyBtn) { copyBtn.removeEventListener('click', handleCopyData); copyBtn.addEventListener('click', handleCopyData); }
                 if (blobBtn) { blobBtn.removeEventListener('click', handleCreateBlobLink); blobBtn.addEventListener('click', handleCreateBlobLink); }
                 console.log("INDEX v11: Action button listeners attached.");
             }

            // --- Button Handlers ---
            function handleCopyData(event) { /* ... as in v10 ... */
                 console.log("INDEX v11: handleCopyData called.");
                 const button = event.target; const dataOutput = document.getElementById('dataContentOutput');
                 if (dataOutput) copyToClipboard(dataOutput.value, button); else console.error("INDEX v11: #dataContentOutput not found.");
             }
            function handleCreateBlobLink(event) { /* ... as in v10 ... */
                 console.log("INDEX v11: handleCreateBlobLink called.");
                 const button = event.target; button.disabled = true;
                 const dataOutput = document.getElementById('dataContentOutput'); const blobResultArea = document.getElementById('blobUrlResultArea');
                 if (!dataOutput || !blobResultArea) { console.error("INDEX v11: Missing UI for Blob."); if(blobResultArea) blobResultArea.innerHTML = `<p class="status-message error">Error UI.</p>`; button.disabled = false; return; }
                 if (!currentFile) { console.error("INDEX v11: currentFile is null."); blobResultArea.innerHTML = `<p class="status-message error">File info hilang.</p>`; button.disabled = false; return; }
                 const content = dataOutput.value; if (!content) { console.error("INDEX v11: Blob content empty."); blobResultArea.innerHTML = `<p class="status-message error">Konten kosong.</p>`; button.disabled = false; return; }
                 blobResultArea.innerHTML = `<p class="status-message processing">Membuat Blob URL...</p>`;
                 setTimeout(() => { /* Blob creation logic */
                     try {
                         let blob;
                         if (content.startsWith('data:') && content.includes(',')) { blob = dataURLtoBlob(content); if (!blob) throw new Error("Konversi Data URL gagal."); }
                         else { const mimeType = currentFile.type || 'application/octet-stream'; blob = new Blob([content], { type: mimeType }); }
                         console.log(`INDEX v11: Blob created: Type=${blob.type}, Size=${blob.size}`);
                         revokeCurrentBlobUrl(); currentBlobUrl = URL.createObjectURL(blob);
                         console.log(`INDEX v11: Blob URL: ${currentBlobUrl}`);
                         blobResultArea.innerHTML = `<p class="status-message success">Tautan unduh lokal (Blob URL) siap:</p><p><strong>PENTING:</strong> Tautan ini <strong>sementara</strong> & hanya untuk browser ini.</p><a href="${currentBlobUrl}" download="${escapeHtml(currentFile.name || 'download')}" title="Unduh ${escapeHtml(currentFile.name)}">Unduh File (${escapeHtml(currentFile.name || 'file')})</a><p style="margin-top:10px;"><small>URL: <code>${currentBlobUrl}</code></small></p>`;
                     } catch (error) { console.error("INDEX v11: Error creating Blob:", error); revokeCurrentBlobUrl(); blobResultArea.innerHTML = `<p class="status-message error">Gagal membuat tautan: ${escapeHtml(error.message)}</p>`; }
                     finally { button.disabled = false; }
                 }, 10);
             }

            // --- Helper Functions ---
            function postToPreview(message) {
                 if (!previewFrame?.contentWindow) { console.error("INDEX v11: Preview frame not available for postMessage."); return; }
                 console.log(`INDEX v11: Posting message to preview (Origin: ${previewFrameOrigin}):`, message);
                 try { previewFrame.contentWindow.postMessage(message, previewFrameOrigin); }
                 catch (e) { console.error("INDEX v11: Error sending postMessage:", e); }
             }
            function clearPreviousState() {
                 console.log("INDEX v11: Clearing previous state.");
                 revokeCurrentBlobUrl();
                 document.getElementById('fileInfo')?.remove();
                 document.getElementById('dataSection')?.remove();
                 outputArea.querySelectorAll('.status-message').forEach(el => { if (el.parentNode === outputArea) el.remove(); });
                 currentFile = null;
                 postToPreview({ type: 'clearPreview' }); // Tell iframe to clear
                 if(initialMessage) initialMessage.style.display = 'block'; // Show initial message again if hidden
            }
            function clearProcessingMessage() { outputArea.querySelector('.status-message.processing')?.remove(); }
            function revokeCurrentBlobUrl() { /* ... as in v10 ... */ if (currentBlobUrl) { console.log(`INDEX v11: Revoking Blob URL: ${currentBlobUrl}`); URL.revokeObjectURL(currentBlobUrl); currentBlobUrl = null; document.getElementById('blobUrlResultArea')?.remove(); /* More robust clear */ } }
            function dataURLtoBlob(dataurl) { /* ... as in v10 ... */
                if (!dataurl || typeof dataurl !== 'string' || !dataurl.startsWith('data:') || !dataurl.includes(',')) { console.error("INDEX v11: Invalid DataURL format."); return null; }
                try { const arr = dataurl.split(','); const mimeMatch = arr[0].match(/:(.*?)(?:;base64)?$/i); const mime = mimeMatch?.[1] || 'application/octet-stream'; const bstr = atob(arr[1]); let n = bstr.length; const u8arr = new Uint8Array(n); while(n--){ u8arr[n] = bstr.charCodeAt(n); } return new Blob([u8arr], { type: mime }); }
                catch (e) { console.error("INDEX v11: Error in dataURLtoBlob:", e); return null; }
            }
            function copyToClipboard(textToCopy, buttonElement) { /* ... as in v10 ... */
                if (!navigator.clipboard) { alert('Fitur salin otomatis tidak didukung/diizinkan.'); return; } if (!textToCopy) return;
                const originalText = buttonElement.textContent; buttonElement.disabled = true; buttonElement.textContent = 'Menyalin...';
                navigator.clipboard.writeText(textToCopy).then(() => { buttonElement.textContent = 'Disalin!'; setTimeout(() => { buttonElement.textContent = originalText; buttonElement.disabled = false; }, 2000); })
                .catch(err => { console.error('INDEX v11: Copy failed: ', err); buttonElement.textContent = 'Gagal!'; alert('Gagal menyalin.'); setTimeout(() => { buttonElement.textContent = originalText; buttonElement.disabled = false; }, 2500); });
             }
             function formatBytes(bytes, decimals = 2) { /* ... as in v10 ... */
                if (!+bytes || bytes < 0) return '0 Bytes'; const k = 1024; const dm = decimals < 0 ? 0 : decimals; const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB', 'PB']; const i = Math.floor(Math.log(bytes) / Math.log(k)); const index = Math.min(i, sizes.length - 1); return `${parseFloat((bytes / Math.pow(k, index)).toFixed(dm))} ${sizes[index]}`;
             }
             function escapeHtml(unsafe) { /* ... as in v10 ... */
                 if (typeof unsafe !== 'string') { try { return String(unsafe); } catch (e) { return '';} }
                 return unsafe.replace(/&/g, "&").replace(/</g, "<").replace(/>/g, ">").replace(/"/g, "\"").replace(/'/g, "'");
             }

            console.log("INDEX v11 Script: Initialization complete. Waiting for iframe 'previewReady'.");

        }); // End DOMContentLoaded
    </script>

</body>
</html>
